#!/bin/bash

#-------------------------------------------------------------------------------------------------------
# Author - Luís Assunção | assunluis80@gmail.com
# Refactored for Performance & Consistency
#-------------------------------------------------------------------------------------------------------

# Trap interrupts to exit cleanly
trap "exit 1" INT TERM

#-------------------------------------------------------------------------------------------------------
# CONFIGURATION & CONSTANTS
#-------------------------------------------------------------------------------------------------------

VHOSTS_VERSION="0.4.2"
NGINX_LOGS_DIR='/var/log/nginx'
DEV_BOX_F="/home/${USER}/DevBox"
SITES_ENABLED="/etc/nginx/sites-enabled"
SITES_AVAILABLE="/etc/nginx/sites-available"
USER_CURRENT=$(whoami)

#-------------------------------------------------------------------------------------------------------
# PALETTE & STYLING
#-------------------------------------------------------------------------------------------------------

# Reset
Reset='\033[0m'

# Regular Colors
Red='\033[0;31m'
Green='\033[0;32m'
Yellow='\033[0;33m'
Blue='\033[0;34m'
Purple='\033[0;35m'
Cyan='\033[0;36m'
White='\033[0;37m'
Grey='\033[0;90m'

# Bold
RedB='\033[1;31m'
GreenB='\033[1;32m'
YellowB='\033[1;33m'
BlueB='\033[1;34m'
PurpleB='\033[1;35m'
CyanB='\033[1;36m'
WhiteB='\033[1;37m'

# Semantic Mapping
Col_Title="${PurpleB}"
Col_Option="${Blue}"
Col_Key="${Cyan}"
Col_Value="${Grey}"
Col_Accent="${Yellow}"

Msg_Error="${RedB}[ERROR]${Reset}"
Msg_Success="${GreenB}[OK]${Reset}"
Msg_Warn="${YellowB}[WARNING]${Reset}"
Msg_Info="${BlueB}[INFO]${Reset}"

SCRIPT_TITLE="${Col_Title}nGinx VHosts${Reset}"

#-------------------------------------------------------------------------------------------------------
# HELPER FUNCTIONS
#-------------------------------------------------------------------------------------------------------

function show_header() {
    clear
    printf "\n%b\n" "${SCRIPT_TITLE}"
}

function show_version() {
    printf "\n%b - Version: %b%s%b\n" "${SCRIPT_TITLE}" "${Col_Accent}" "${VHOSTS_VERSION}" "${Reset}"
}

function reload_nginx() {
    local result
    result=$(sudo service nginx reload 2>&1)
    
    if [[ -n "${result}" ]]; then
        printf "\n%b - %s\n" "${Msg_Error}" "nGinx Server Was Unable to Reload."
        printf "%s\n" "${result}"
        return 1
    fi
    return 0
}

function get_php_versions() {
    # Optimized: Looks directly in /etc/php for FPM configurations instead of using slow 'apt list'
    # Returns an array of versions (e.g., 7.4 8.0 8.1)
    if [[ -d "/etc/php" ]]; then
        find /etc/php -maxdepth 1 -mindepth 1 -type d -printf '%f\n' | sort -V | while read -r version; do
            if [[ -d "/etc/php/${version}/fpm" ]]; then
                echo "${version}"
            fi
        done
    fi
}

function check_root() {
    # Ensures sudo functionality is available
    if ! sudo -v; then
        printf "\n%b - Sudo privileges are required for this operation.\n" "${Msg_Error}"
        exit 1
    fi
}

#-------------------------------------------------------------------------------------------------------
# HELP MENU
#-------------------------------------------------------------------------------------------------------

function vhosts_help() {
    printf "\n%bUsage: %b %s %b[%b-option %b|%b --longoption%b]\n" "${Col_Title}" "${Reset}" "${0##*/}" "${Reset}" "${Col_Key}" "${Col_Accent}" "${Col_Option}" "${Reset}"
    printf "\n%bOptions:%b\n\n" "${Col_Accent}" "${Reset}"
    
    printf "\t[%b-c%b | %b--create%b]   %b=>%b\tCreate a VHost\n" "${Col_Key}" "${Col_Accent}" "${Col_Option}" "${Reset}" "${Col_Title}" "${Col_Value}"
    printf "\t[%b-e%b | %b--enable%b]   %b=>%b\tEnable a VHost\n" "${Col_Key}" "${Col_Accent}" "${Col_Option}" "${Reset}" "${Col_Title}" "${Col_Value}"
    printf "\t[%b-d%b | %b--disable%b]  %b=>%b\tDisable a VHost\n" "${Col_Key}" "${Col_Accent}" "${Col_Option}" "${Reset}" "${Col_Title}" "${Col_Value}"
    printf "\t[%b-v%b | %b--view%b]     %b=>%b\tView or Edit a VHost\n" "${Col_Key}" "${Col_Accent}" "${Col_Option}" "${Reset}" "${Col_Title}" "${Col_Value}"
    printf "\t[%b-r%b | %b--remove%b]   %b=>%b\tRemove a VHost\n" "${Col_Key}" "${Col_Accent}" "${Col_Option}" "${Reset}" "${Col_Title}" "${Col_Value}"
    printf "\t[%b-V%b | %b--version%b]  %b=>%b\tShow Binary Version\n" "${Col_Key}" "${Col_Accent}" "${Col_Option}" "${Reset}" "${Col_Title}" "${Col_Value}"
    printf "\t[%b-l%b | %b--list%b]     %b=>%b\tList All Virtual Hosts\n" "${Col_Key}" "${Col_Accent}" "${Col_Option}" "${Reset}" "${Col_Title}" "${Col_Value}"
    printf "\t[%b-h%b | %b--help%b]     %b=>%b\tDisplay Help\n" "${Col_Key}" "${Col_Accent}" "${Col_Option}" "${Reset}" "${Col_Title}" "${Col_Value}"
    printf "\n"
}

#-------------------------------------------------------------------------------------------------------
# LIST HOSTS
#-------------------------------------------------------------------------------------------------------

function list_v_hosts() {
    local ena_idx=0
    local ava_idx=0
    
    # Use globbing safely or empty array if no files
    shopt -s nullglob
    local enabled_hosts=("${SITES_ENABLED}"/*)
    local available_hosts=("${SITES_AVAILABLE}"/*)
    shopt -u nullglob

    show_header

    printf "\n%bList of Available VHosts%b\n\n" "${Col_Accent}" "${Reset}"
    for path in "${available_hosts[@]}"; do
        printf "\t%b%d:%b %s\n" "${Col_Accent}" "${ava_idx}" "${Col_Value}" "$(basename "${path}")"
        ((ava_idx++))
    done

    printf "\n%bList of Enabled VHosts%b\n\n" "${Green}" "${Reset}"
    for path in "${enabled_hosts[@]}"; do
        printf "\t%b%d:%b %s\n" "${Green}" "${ena_idx}" "${Col_Value}" "$(basename "${path}")"
        ((ena_idx++))
    done

    exit 0
}

#-------------------------------------------------------------------------------------------------------
# ENABLE HOST
#-------------------------------------------------------------------------------------------------------

function enable_v_host() {
    check_root
    local ava_idx=0
    local available_hosts=()
    
    # Populate array safely
    if [[ -d "${SITES_AVAILABLE}" ]]; then
        while IFS= read -r line; do available_hosts+=("${line}"); done < <(ls -A1 "${SITES_AVAILABLE}")
    fi

    show_header
    printf "\n%bList of Available VHosts%b\n\n" "${Col_Accent}" "${Reset}"

    for host in "${available_hosts[@]}"; do
        printf "\t%b%d:%b %s\n" "${Col_Accent}" "${ava_idx}" "${Col_Value}" "${host}"
        ((ava_idx++))
    done

    printf "\n%bFrom the List Above, Choose the VHost to enable [INDEX]:%b " "${Col_Key}" "${Reset}"
    read -r vhost_idx

    local vhost_to_enable="${available_hosts[$vhost_idx]}"

    if [[ -z "${vhost_idx}" ]] || [[ -z "${vhost_to_enable}" ]]; then
        printf "\n%b - Provide a Valid VHost Index!\n" "${Msg_Error}"
        exit 1
    fi

    if [[ -f "${SITES_ENABLED}/${vhost_to_enable}" ]]; then
        printf "\n%b - The VHost '%b%s%b' is Already Enabled!\n" "${Msg_Warn}" "${Col_Accent}" "${vhost_to_enable}" "${Reset}"
        exit 1
    fi

    printf "\n"
    sudo ln -s "${SITES_AVAILABLE}/${vhost_to_enable}" "${SITES_ENABLED}/${vhost_to_enable}"

    if reload_nginx; then
        printf "\n%b - The VHost '%b%s%b' was Enabled with Success.\n" "${Msg_Success}" "${Col_Accent}" "${vhost_to_enable}" "${Reset}"
    else
        exit 1
    fi
}

#-------------------------------------------------------------------------------------------------------
# DISABLE HOST
#-------------------------------------------------------------------------------------------------------

function disable_v_host() {
    check_root
    local ena_idx=0
    local enabled_hosts=()

    if [[ -d "${SITES_ENABLED}" ]]; then
        while IFS= read -r line; do enabled_hosts+=("${line}"); done < <(ls -A1 "${SITES_ENABLED}")
    fi

    show_header
    printf "\n%bList of Enabled VHosts%b\n\n" "${Green}" "${Reset}"

    for host in "${enabled_hosts[@]}"; do
        printf "\t%b%d:%b %s\n" "${Green}" "${ena_idx}" "${Col_Value}" "${host}"
        ((ena_idx++))
    done

    printf "\n%bFrom the List Above, Choose the VHost to Disable [INDEX]:%b " "${Col_Key}" "${Reset}"
    read -r vhost_idx

    local vhost_to_disable="${enabled_hosts[$vhost_idx]}"

    if [[ -z "${vhost_idx}" ]] || [[ -z "${vhost_to_disable}" ]]; then
        printf "\n%b - Provide a Valid VHost Index!\n" "${Msg_Error}"
        exit 1
    fi

    if [[ ! -f "${SITES_ENABLED}/${vhost_to_disable}" ]]; then
        printf "\n%b - The VHost is already disabled or does not exist.\n" "${Msg_Error}"
        exit 1
    fi

    printf "\n"
    sudo rm "${SITES_ENABLED}/${vhost_to_disable}"

    if reload_nginx; then
        printf "\n%b - The VHost '%b%s%b' was Disabled with Success.\n" "${Msg_Success}" "${Col_Accent}" "${vhost_to_disable}" "${Reset}"
    else
        exit 1
    fi
}

#-------------------------------------------------------------------------------------------------------
# VIEW / EDIT HOST
#-------------------------------------------------------------------------------------------------------

function open_v_host() {
    check_root
    local ava_idx=0
    local app_idx=0
    local editor_apps=(vi vim nano gedit code)
    local available_hosts=()

    if [[ -d "${SITES_AVAILABLE}" ]]; then
        while IFS= read -r line; do available_hosts+=("${line}"); done < <(ls -A1 "${SITES_AVAILABLE}")
    fi

    show_header
    printf "\n%bList of Available VHosts%b\n\n" "${Col_Accent}" "${Reset}"

    for host in "${available_hosts[@]}"; do
        printf "\t%b%d:%b %s\n" "${Col_Accent}" "${ava_idx}" "${Col_Value}" "${host}"
        ((ava_idx++))
    done

    printf "\n%bFrom the List Above, Choose the VHost [INDEX]:%b " "${Col_Key}" "${Reset}"
    read -r vhost_idx
    local vhost_to_view="${available_hosts[$vhost_idx]}"

    if [[ -z "${vhost_idx}" ]] || [[ -z "${vhost_to_view}" ]]; then
        printf "\n%b - Provide a Valid VHost Index.\n" "${Msg_Error}"
        exit 1
    fi

    printf "\n%bChoose the VHost Editor App%b\n\n" "${Col_Option}" "${Reset}"
    for app in "${editor_apps[@]}"; do
        printf "\t%b%d: %b%s\n" "${Col_Option}" "${app_idx}" "${Col_Value}" "${app}"
        ((app_idx++))
    done

    printf "\n%bFrom the List Above, Choose the App to Use [INDEX]:%b " "${Col_Key}" "${Reset}"
    read -r app_to_use_idx
    local editor_to_use=${editor_apps[$app_to_use_idx]}

    if [[ -z "${editor_to_use}" ]]; then
        printf "\n%b - Invalid Editor Selection.\n" "${Msg_Error}"
        exit 1
    fi

    if ! command -v "${editor_to_use}" &> /dev/null; then
        printf "\n%b - Editor '%s' NOT FOUND on the system.\n" "${Msg_Error}" "${editor_to_use}"
        exit 1
    fi

    sudo "${editor_to_use}" "${SITES_AVAILABLE}/${vhost_to_view}"

    printf "\n%bThe VHost was edited. Want to Reload? (n/Y):%b " "${Col_Key}" "${Reset}"
    read -r reload_ans

    if [[ "${reload_ans}" != "n" && "${reload_ans}" != "N" ]]; then
        if reload_nginx; then
            printf "\n%b - VHost edited and server reloaded.\n" "${Msg_Success}"
        fi
    fi
}

#-------------------------------------------------------------------------------------------------------
# REMOVE HOST
#-------------------------------------------------------------------------------------------------------

function remove_v_host() {
    check_root
    local ava_idx=0
    local available_hosts=()

    if [[ -d "${SITES_AVAILABLE}" ]]; then
        while IFS= read -r line; do available_hosts+=("${line}"); done < <(ls -A1 "${SITES_AVAILABLE}")
    fi

    show_header
    printf "\n%bList of Available VHosts%b\n\n" "${Col_Accent}" "${Reset}"

    for host in "${available_hosts[@]}"; do
        printf "\t%b%d:%b %s\n" "${Col_Accent}" "${ava_idx}" "${Col_Value}" "${host}"
        ((ava_idx++))
    done

    printf "\n%bFrom the List Above, Choose the VHost to Remove [INDEX]:%b " "${Col_Key}" "${Reset}"
    read -r host_idx
    local host_to_remove="${available_hosts[$host_idx]}"

    if [[ -z "${host_idx}" ]] || [[ -z "${host_to_remove}" ]]; then
        printf "\n%b - You Must Provide the VHost Index.\n" "${Msg_Error}"
        exit 1
    fi

    printf "\n%bDo You Really Want to Remove '%s'? (N/y):%b " "${RedB}" "${host_to_remove}" "${Reset}"
    read -r confirmation

    if [[ "${confirmation}" == "n" || "${confirmation}" == "N" || -z "${confirmation}" ]]; then
        printf "\n%b - Operation Cancelled.\n" "${Msg_Warn}"
        exit 1
    fi

    local filename="${host_to_remove%.*}"
    printf "\n%bRemoving Virtual Host '%s'...
" "${Col_Accent}" "${host_to_remove}"

    [[ -f "${SITES_ENABLED}/${host_to_remove}" ]] && sudo rm "${SITES_ENABLED}/${host_to_remove}"
    [[ -f "${SITES_AVAILABLE}/${host_to_remove}" ]] && sudo rm "${SITES_AVAILABLE}/${host_to_remove}"
    [[ -f "${NGINX_LOGS_DIR}/${filename}_errors.log" ]] && sudo rm "${NGINX_LOGS_DIR}/${filename}_errors.log"
    [[ -f "${NGINX_LOGS_DIR}/${filename}_access.log" ]] && sudo rm "${NGINX_LOGS_DIR}/${filename}_access.log"

    if reload_nginx; then
        printf "\n%b - The VHost was Removed with Success.\n" "${Msg_Success}"
    fi
}

#-------------------------------------------------------------------------------------------------------
# CREATE HOST
#-------------------------------------------------------------------------------------------------------

function create_v_host() {
    check_root
    local min_port_num=2000
    local grep_name="^[a-z0-9]*$"
    local tmp_folder="/tmp/TempHosts"
    
    mkdir -p "${tmp_folder}"

    local script_dir
    script_dir=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &> /dev/null && pwd)
    local main_conf="${script_dir}/../templates/default.conf"

    # Fallback to local path if relative fails
    if [[ ! -f "${main_conf}" ]]; then
         main_conf="./templates/default.conf"
    fi

    show_header
    printf "\n%bCreating New Virtual Host%b\n\n" "${Green}" "${Reset}"

    # PHP Versions
    local php_versions=($(get_php_versions))
    
    if [[ ${#php_versions[@]} -eq 0 ]]; then
        printf "\n%b - No PHP-FPM versions found in /etc/php/.\n" "${Msg_Error}"
        exit 1
    fi

    # 1. Project Port
    printf "%bPROJECT PORT%b = " "${Col_Key}" "${Reset}"
    read -r project_port
    project_port=$(echo "${project_port}" | xargs)

    if [[ -z "${project_port}" ]] || [[ "${project_port}" -le $min_port_num ]]; then
        printf "\n%b - Port must be greater than %d.\n" "${Msg_Error}" "${min_port_num}"
        exit 1
    fi

    if grep -q "${project_port}" "${SITES_AVAILABLE}"/* 2>/dev/null; then
         printf "\n%b - Port %s is likely already in use in existing configs.\n" "${Msg_Error}" "${project_port}"
         exit 1
    fi

    # 2. Project Name
    printf "%bPROJECT NAME%b = " "${Col_Key}" "${Reset}"
    read -r project_name
    project_name=$(echo "${project_name}" | xargs | tr '[:upper:]' '[:lower:]')

    if [[ -z "${project_name}" ]] || ! [[ "${project_name}" =~ ${grep_name} ]]; then
        printf "\n%b - Invalid Project Name (alphanumeric only).\n" "${Msg_Error}"
        exit 1
    fi

    # 3. PHP Version
    printf "\n%bList of PHP Versions%b\n\n" "${Col_Accent}" "${Reset}"
    local ver_idx=0
    for phpV in "${php_versions[@]}"; do
        printf "\t%b%d: %bVersion %s\n" "${Col_Accent}" "${ver_idx}" "${Col_Value}" "${phpV}"
        ((ver_idx++))
    done

    printf "\n%bSelect PHP Version [INDEX]%b: " "${Col_Key}" "${Reset}"
    read -r php_ver_idx
    local selected_php_version="${php_versions[$php_ver_idx]}"

    if [[ -z "${selected_php_version}" ]]; then
        printf "\n%b - Invalid PHP Version selected.\n" "${Msg_Error}"
        exit 1
    fi

    # 4. Webroot
    printf "\n%bFULL PATH TO WEBROOT%b = " "${Col_Key}" "${Reset}"
    read -r full_path_to_webroot
    full_path_to_webroot=$(echo "${full_path_to_webroot}" | xargs)

    if [[ -z "${full_path_to_webroot}" ]]; then
        printf "\n%b - Path cannot be empty.\n" "${Msg_Error}"
        exit 1
    fi

    # Preparation
    local php_v_unds
    php_v_unds=$(echo "${selected_php_version}" | tr . _)
    local tmp_conf_file="${project_name}_${project_port}_${php_v_unds}.vhost"
    local tmp_file_path="${tmp_folder}/${tmp_conf_file}"

    cp "${main_conf}" "${tmp_file_path}"

    # Replacements
    sed -i "s|#{port}|${project_port}|g" "${tmp_file_path}"
    sed -i "s|#{host}|${project_name}|g" "${tmp_file_path}"
    sed -i "s|#{php_version}|${selected_php_version}|g" "${tmp_file_path}"
    sed -i "s|#{project_path}|${full_path_to_webroot}|g" "${tmp_file_path}"
    sed -i "s|#{app_log}|${php_v_unds}|g" "${tmp_file_path}"
    sed -i "s|#{sys_user}|${USER_CURRENT}|g" "${tmp_file_path}"

    printf "\n"

    # Validate Config
    if ! sudo nginx -t &>/dev/null; then
         # We don't want to break if main config is currently broken, but we should warn
         printf "%b - Warning: Nginx config currently reports errors. Proceeding anyway...\n" "${Msg_Warn}"
    fi

    sudo mv "${tmp_file_path}" "${SITES_AVAILABLE}/"

    printf "\n%bVirtual Host Created. Want to Enable It? (n/Y): %b" "${Green}" "${Reset}"
    read -r enable_host

    if [[ "${enable_host}" != "n" && "${enable_host}" != "N" ]]; then
        sudo ln -s "${SITES_AVAILABLE}/${tmp_conf_file}" "${SITES_ENABLED}/${tmp_conf_file}"
        
        if reload_nginx; then
            printf "\n%b - Access here: %bhttp://localhost:%s%b\n" "${Msg_Info}" "${Col_Value}" "${project_port}" "${Reset}"
            printf "\n%b - VHost '%s' Enabled Successfully!\n" "${Msg_Success}" "${tmp_conf_file}"
        fi
    fi

    exit 0
}

#-------------------------------------------------------------------------------------------------------
# MAIN EXECUTION
#-------------------------------------------------------------------------------------------------------

case "$1" in
    -c|--create)  create_v_host ;; 
    -e|--enable)  enable_v_host ;; 
    -d|--disable) disable_v_host ;; 
    -v|--view)    open_v_host ;; 
    -r|--remove)  remove_v_host ;; 
    -V|--version) show_version ;; 
    -l|--list)    list_v_hosts ;; 
    -h|--help)    vhosts_help ;; 
    *) 
        printf "\n%b - Invalid Option or No Argument Supplied.\n" "${Msg_Error}"
        vhosts_help
        exit 1
        ;; 
esac